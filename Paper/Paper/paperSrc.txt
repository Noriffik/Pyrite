<img src="http://noant.github.io/Pyrite/Paper/Img/main.JPG" alt="image"/>

Всем добрый день. В качестве хобби написал программу, которую можно использовать как часть системы “умный дом”. Чтобы сразу заинтересовать читателя, продемонстрирую некоторую малую часть сценариев использования ПО:
<cut text="Просмотр" />
<table>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Gif/pyriteGif3_3.gif" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Gif/pyriteGif3_3.gif" alt="image"/></a>
</td>
<td>
Включение и выключение ZWave лампочки через мобильное приложение
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Gif/pyriteGif1_1.gif" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Gif/pyriteGif1_1.gif" alt="image"/></a>
</td>
<td>
При появлении устройства в сети (по приходу пользователя домой) происходит <br/>включение ZWave лампочки, релейного модуля Modbus RTU, запуск компьютера через WakeOnLan и включение ТВ
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Gif/pyriteGif2_2.gif" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Gif/pyriteGif2_2.gif" alt="image"/></a>
</td>
<td>
Запуск браузера, переход на яндекс.радио,<br/> перелистывание треков (эмуляция горячих клавиш) 
</td>
</tr>
</table>

<b>Вкратце</b>: 
1)	Основная часть ПО - сервер, который крутится на ОС Windows, написан на C#;
2)	Клиент на ОС Android, написан на Java;
3)	Планируются клиенты на UWP и IOS, web-клиент.

<b>Некоторые особенности ПО</b>:
1)	Конструктор сценариев. Создание сложных сценариев с циклами и условиями;
2)	Работа с устройствами ZWave и Modbus;
3)	Вложенность сценариев. Можно один сценарий использовать в другом в качестве процедуры;
4)	Запуск удаленного сценария. В сценарии текущего сервера можно запускать сценарий удаленного;
5)	Возможность добавлять в систему свою функциональность посредством создания модулей;
6)	Запуск сценариев с помощью смартфона.

<H3><font color="steelblue">Конструктор сценариев</font></H3>
Программа позволяет создавать как сложный сценарий, так и одиночное действие.

<u>Одиночное действие</u> - это сценарий, который содержит только одно действие. В нем нет возможности создавать циклы и условия, а можно лишь “замапить” определенное действие на кнопку в UI клиента. 
В качестве примера приведу свой способ их использования: создал категорию “Розетки”, в ней собрал все лампы, бытовой вентилятор, светильники, телевизор и компьютер. Теперь, чтобы включить одно из этих устройств, следует открыть клиент на андроиде, зайти в категорию “Розетки” и выбрать соответствующий пункт меню.
Обычно, одиночные действия использовать неудобно, так как различные устройства удобно запускать при каком-то условии или хотя-бы не по одному. Именно для этого нужен “сложный сценарий”, о чем далее.

<u>Конструктор сложного сценария</u> позволяет создавать сценарии с циклами и условиями. Имеет два режима: просмотр и редактирование.
<table>
<tr>
<td>
Пример сценария в режиме просмотра
</td>
<td>
Пример сценария в режиме редактирования
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/scen_example_view.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/scen_example_view.jpg" width="450" alt="image"/></a>
</td>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/scen_example_edit.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/scen_example_edit.jpg" width="450" alt="image"/></a>
</td>
</tr>
</table>
<i>ЕСЛИ и ИНАЧЕ в конструкторе</i>. В данных конструкциях можно создавать цепочки условий с логическими операторами НЕ, ИЛИ, И. Также, можно создавать группу условий и использовать операторы непосредственно с группой. Если условие остается пустым, то оно автоматом вычисляется как ложь. 
Есть некоторое количество встроенных проверок (такие как проверка на дату, время и т.д.), а так же несколько в качестве подключаемых модулей.
<i>Цикл ПОКА в конструкторе</i>. Цикл состоит из условия и тела. Условие создается аналогично тому, как он создается в конструкции ЕСЛИ (группы условий, операторы НЕ, ИЛИ, И).
<table>
<tr>
<td>
Оператор ЕСЛИ и возможные условия
</td>
<td>
Оператор ПОКА
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/if_example.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/if_example.jpg" alt="image"/></a>
</td>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/while_example.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/while_example.jpg" alt="image"/></a>
</td>
</tr>
</table>
<table>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/action_example.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/action_example.jpg" alt="image"/></a>
</td>
<td>
Тела ЕСЛИ, ИНАЧЕ и ПОКА нужно чем-то заполнять.<br/> Собственно, это содержимое и есть самое важное в сценарии.
</td>
</tr>
</table>
<table>
<tr>
<td>
Основное окно конструктора сценариев
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/constructor_window.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/constructor_window.jpg" width="960" alt="image"/></a>
</td>
</tr>
</table>
Так же можно настроить следующие параметры сценариев:
- Запуск извне (вкл/выкл), позволяет запретить или разрешить запуск сценария с другой машины или из клиента;
- Автоматический запуск сценария при старте системы;
- Выбор категории сценария, позволяет отображать в UI клиента пункт меню для запуска сценария в определенной категории.

<H3><font color="steelblue">Работа с устройствами ZWave и Modbus</font></H3>
На данный момент система поддерживает устройства ZWave (на основе openzwave) и Modbus RTU (на основе nmodbus).

<u>ZWave</u> - это беспроводной протокол связи, использующийся в домашней автоматизации. Для реализации протокола используются миниатюрные маломощные радиочастотные модули. Сейчас на рынке ZWave представлен довольно обширный перечень устройств, такие как ZWave лампочки, розетки, релейные модули, переключатели, замки, датчики температуры (влажности, движения, протечки), терморегуляторы, устройства управления кондиционером и т.д. Так же распространены мультисенсоры - устройства, сочетающие несколько датчиков (например датчик освещенности, присутствия, температуры и дверной датчик), что весьма привлекательно с точки зрения финансовых затрат и расположения в помещении.

В моей программе модуль ZWave позволяет производить все стандартные операции с устройствами, такие как удаление,  добавление устройств, сброс контроллера. Так же можно использовать несколько ZWave контроллеров, конечный пользователь не увидит разницы. К примеру, можно осуществить снятие показаний температуры с датчика, который соединён с контроллером «А» и запустить кондиционер с помощью контроллера «Б». Тут нет ни каких ограничений, любое действие и проверка осуществляется стандартными способами и добавляется в конструкторе сценариев.
<table>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/zwave.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/zwave.jpg" alt="image" /></a>
</td>
<td>
Рынок ZWave устройств достаточно широк. Имеется множество исполнительных устройств, таких как релейные модули, лампочки, устройства для работы с кондиционером, <br/>терморегуляторы, регуляторы теплого пола, розетки, переключатели. Так же существует множество датчиков: датчик открытия двери, температуры, датчик протечки, датчик присутствия и т.д. В качестве контроллера ZWave можно использовать USB stick
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/zwave_main_window.png" target="_blank"><img src="http://noant.github.io/Pyrite/PyriteUI/zwave_main_window.png" alt="image"></a>
</td>
<td>
Основное окно ZWave модуля
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/zwave_select_controller_window.png" target="_blank"><img src="http://noant.github.io/Pyrite/PyriteUI/zwave_select_controller_window.png" alt="image"></a>
</td>
<td>
Окно выбора контроллера и операций с ним
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/zwave_select_node_window.png" target="_blank"><img width="450" src="http://noant.github.io/Pyrite/PyriteUI/zwave_select_node_window.png" alt="image"></a>
</td>
<td>
Выбор узла (датчики, переключатели и т.д.)
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/zwave_select_value_window.png" target="_blank"><img width="450" src="http://noant.github.io/Pyrite/PyriteUI/zwave_select_value_window.png" alt="image"></a>
</td>
<td>
Выбор параметра узла (включен/выключен, различные числовые параметры, такие как температура, влажность и т.д.)
</td>
</tr>
</table>
<u>Modbus</u> - это проводной протокол, применяемый для связи между электронными устройствами, которые его поддерживают. В контексте нашей программы может быть полезен для работы с релейными модулями, для чего я его и использую у себя дома.
<table>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/relay_module_modbus.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/relay_module_modbus.jpg" alt="image"  width="200"/></a>
</td>
<td>
Релейный модуль Modbus. Соединяется с контроллером через COM-порт
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/module_modbus_action.png" target="_blank"><img src="http://noant.github.io/Pyrite/PyriteUI/module_modbus_action.png" alt="image" width="200"/></a>
</td>
<td>
Основное окно Modbus RTU модуля
</td>
</tr>
</table>
<H3><font color="steelblue">Вложенность сценариев</font></H3>
Вложенность сценариев используется для декомпозиции сценариев умного дома. Часто бывают такие ситуации, когда одно действие участвует во многих сценариях (например, отключение всех бытовых устройств может происходить по нажатию на пункт меню в программе, по сценарию выхода всех wi-fi устройств из сети, просто по таймеру), и поэтому каждый раз создавать (или править) одинаковый алгоритм в каждом из сценариев не представляется удобным. Для этого существует такое встроенное действие, которое позволяет запускать уже созданный сценарий в текущем. Так же это может быть удобно, когда часто добавляются новые бытовые устройства (или другие частые изменения в алгоритме работы “умного дома”), для изменения работы всех сценариев достаточно будет изменить лишь один сценарий, который используется в них.
<table>
<tr>
<td>
Действие "Существующий сценарий" в списке
</td>
<td>
Выбор существующего сценария
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/existing_scen.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/existing_scen.jpg" alt="image"/></a>
</td>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/existing_scen_window.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/existing_scen_window.jpg" alt="image"/></a>
</td>
</tr>
</table>
<H3><font color="steelblue">Запуск удаленных сценариев</font></H3>
Посредством запуска удаленных сценариев можно запускать сценарий одного сервера в сценарии другого. В качестве примера хочу привести мой вариант использования этого функционала: <i>создал сценарий (на домашнем сервере) под называется “свет+мультимедиа”, который включает свет в помещении, запускает мой десктоп используя WakeOnLan, включает тв, к которому подключен десктоп и ждет пока на нем (десктопе) запустится экземпляр нашей программы, затем запускает на ней сценарии “включить музыку” и “звук на 20 единиц” с помощью запуска удаленных сценариев.
</i>
<table>
<tr>
<td>
"Запуск удаленного сценария" в списке
</td>
<td>
Выбор сервера и его сценария
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/remote_scenario.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/remote_scenario.jpg" alt="image"/></a>
</td>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/remote_scenario_window.jpg" target="_blank"><img width="500" src="http://noant.github.io/Pyrite/Paper/Img/remote_scenario_window.jpg" alt="image"/></a>
</td>
</tr>
</table>
<H3><font color="steelblue">Написание собственных модулей</font></H3>
Помимо того, что пользователь может создавать сложные сценарии штатными средствами, программа позволяет “расширять” ее пользовательскими модулями на C#. Все элементы действий и проверок в сценариях (такие как “Проверка по дате”, “Показать сообщение”, “Действие Modbus”, “Действие ZWave” и т.п.) это классы, унаследованные от ICustomAction и ICustomChecker. Следуя определенным правилам, любой пользователь может создать свой модуль, который может быть очень простым (например, озвучивание текущей температуры воздуха за окном), так и сложным, за которым может крыться целый фреймворк. Достаточно наследоваться от интерфейсов ICustomAction или ICustomChecker, расставить несколько атрибутов, скомпилировать DLL и добавить в программу через вкладку “МОДУЛИ” (полная инструкция создания модулей <a href="http://noant.github.io/Pyrite/PyriteMods.htm"  target="_blank">http://noant.github.io/Pyrite/PyriteMods.htm</a>).
<table>
<tr>
<td>
Вкладка "МОДУЛИ"
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/module.png" target="_blank"><img width="950" src="http://noant.github.io/Pyrite/PyriteUI/module.png" alt="image"/></a>
</td>
</tr>
</table>

<H3><font color="steelblue">Запуск сценариев с помощью смартфона</font></H3>*пока только OS Android

Сценарии отображаются на главном экране и в категориях. Категория является виртуальной “папкой”. При запуске сценария обновляется статус соответствующей кнопки.
<table>
<tr>
<td>
Экран настроек соединения
</td>
<td>
Экран с запуском сценариев
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/android_2.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/android_2.jpg" alt="image" width="300"/></a>
</td>
<td>
<a href="http://noant.github.io/Pyrite/Paper/Img/android_1.jpg" target="_blank"><img src="http://noant.github.io/Pyrite/Paper/Img/android_1.jpg" alt="image" width="300"/></a>
</td>
</tr>
</table>
Помимо этого, есть возможность запускать сценарии из меню быстрого запуска на PC.
<table>
<tr>
<td>
Меню быстрого запуска
</td>
</tr>
<tr>
<td>
<a href="http://noant.github.io/Pyrite/PyriteUI/fast_window.png" target="_blank"><img width="950" src="http://noant.github.io/Pyrite/PyriteUI/fast_window.png" alt="image"/></a>
</td>
</tr>
</table>
В дальнейшем планируется клиент для UWP, IOS, web, а так же голосовой модуль для управления устройствами (планы на ближайшее будущее) и создания сценариев с помощью голоса (стратегические планы).



Видео напоследок:
<video>https://www.youtube.com/watch?v=kjGzwHfzssI</video>

Страничка программы: http://noant.github.io/Pyrite/
Ссылка для скачивания: http://noant.github.io/Pyrite/downloads.html
Инструкция для пользования: http://noant.github.io/Pyrite/description.html
Инструкция для создания собственных модулей: http://noant.github.io/Pyrite/PyriteMods.htm


P.S.: Если нашли ошибку в программе, то пожалуйста, перешлите ее на <a href="mailto:noant1@yandex.ru" target="_top">noant1@yandex.ru</a>.